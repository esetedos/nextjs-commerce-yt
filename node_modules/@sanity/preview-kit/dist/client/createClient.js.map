{"version":3,"file":"createClient.js","sources":["../../src/client/createClient.ts"],"sourcesContent":["import {\n  createClient as createStandardClient,\n  SanityClient,\n} from '@sanity/client'\nimport {\n  createClient as createStegaClient,\n  SanityStegaClient,\n} from '@sanity/client/stega'\n\nimport type { PreviewKitClientConfig } from './types'\n\nexport type * from './types'\nexport type * from '@sanity/client'\n\n/**\n * @public\n * @deprecated - Please use `createClient` from `@sanity/client/stega` instead\n */\nexport const createClient = (\n  config: PreviewKitClientConfig,\n): SanityClient | SanityStegaClient => {\n  const {\n    encodeSourceMap = detectEnableSourceMap(),\n    encodeSourceMapAtPath,\n    studioUrl = detectStudioUrl(),\n    logger,\n    ...options\n  } = config\n\n  let shouldEncodeSourceMap = encodeSourceMap === true\n\n  // If encodeSourceMap is set to 'auto', then we need to check if we're running on Vercel and on a preview deployment\n  if (encodeSourceMap === 'auto') {\n    shouldEncodeSourceMap = isVercelPreviewEnvironment()\n  }\n\n  if (typeof encodeSourceMap === 'string' && encodeSourceMap !== 'auto') {\n    throw new Error(\n      `Invalid value for encodeSourceMap: ${encodeSourceMap}. Did you mean 'auto'?`,\n    )\n  }\n\n  try {\n    if (shouldEncodeSourceMap && config.resultSourceMap !== false) {\n      if (!studioUrl) {\n        logger?.error?.(\n          '[@sanity/preview-kit]: Content source map enabled client is enabled, but no studioUrl is provided. Falling back to @sanity/client',\n        )\n        return createStandardClient(options)\n      }\n\n      logger?.debug?.(\n        '[@sanity/preview-kit]: Creating source map enabled client',\n      )\n      return createStegaClient({\n        ...options,\n        // Source maps by Content Lake are required in order to know where to insert the encoded source maps into strings\n        resultSourceMap: config.resultSourceMap\n          ? config.resultSourceMap\n          : 'withKeyArraySelector',\n        stega: {\n          enabled: true,\n          studioUrl,\n          logger,\n          filter: encodeSourceMapAtPath\n            ? (props) =>\n                encodeSourceMapAtPath({\n                  path: props.sourcePath,\n                  filterDefault: () => props.filterDefault(props),\n                })\n            : undefined,\n        },\n      })\n    }\n  } catch (err) {\n    // eslint-disable-next-line no-console\n    console.error(\n      '[@sanity/preview-kit]: Error creating client',\n      err,\n      'falling back to non-embedded sourcemap mode',\n    )\n  }\n  return createStandardClient(options)\n}\n\nfunction isVercelPreviewEnvironment() {\n  try {\n    // @ts-expect-error -- VERCEL_ENV is not a declared import.meta.env variable\n    return import.meta.env.VERCEL_ENV === 'preview'\n  } catch {\n    // ignore\n  }\n  try {\n    // eslint-disable-next-line no-process-env\n    return process.env.VERCEL_ENV === 'preview'\n  } catch {\n    // ignore\n  }\n  return false\n}\n\nfunction detectEnableSourceMap(): PreviewKitClientConfig['encodeSourceMap'] {\n  try {\n    // @ts-expect-error -- SANITY_SOURCE_MAP is not a declared import.meta.env variable\n    return import.meta.env.SANITY_SOURCE_MAP === 'true'\n  } catch {\n    // ignore\n  }\n  try {\n    // eslint-disable-next-line no-process-env\n    return process.env.SANITY_SOURCE_MAP === 'true'\n  } catch {\n    // ignore\n  }\n  return false\n}\n\n// eslint-disable-next-line consistent-return\nfunction detectStudioUrl() {\n  try {\n    // @ts-expect-error -- SANITY_STUDIO_URL is not a declared import.meta.env variable\n    return import.meta.env.SANITY_STUDIO_URL\n  } catch {\n    // ignore\n  }\n  try {\n    // eslint-disable-next-line no-process-env\n    return process.env.SANITY_STUDIO_URL\n  } catch {\n    // ignore\n  }\n}\n"],"names":["createClient","config","_a","_b","encodeSourceMap","detectEnableSourceMap","encodeSourceMapAtPath","studioUrl","detectStudioUrl","logger","options","shouldEncodeSourceMap","env","VERCEL_ENV","process","isVercelPreviewEnvironment","Error","concat","resultSourceMap","debug","call","createStegaClient","stega","enabled","filter","props","path","sourcePath","filterDefault","error","createStandardClient","err","console","SANITY_SOURCE_MAP","SANITY_STUDIO_URL"],"mappings":"kGAkBa,MAAAA,EACXC,IAnBF,IAAAC,EAAAC,EAqBQ,MAAAC,gBACJA,EAAkBC,IAAsBC,sBACxCA,EAAAC,UACAA,EAAYC,IAAgBC,OAC5BA,KACGC,GACDT,EAEJ,IAAIU,GAA4C,IAApBP,EAO5B,GAJwB,SAApBA,IACFO,EAoDJ,WACM,IAEK,MAA+B,wBAAnBC,IAAIC,UAAe,CAChC,MAER,CACI,IAEK,MAA2B,YAA3BC,QAAQF,IAAIC,UAAe,CAC5B,MAER,CACO,OAAA,CACT,CAlE4BE,IAGK,iBAApBX,GAAoD,SAApBA,EACzC,MAAM,IAAIY,MACR,sCAAsCC,OAAeb,EAAA,2BAIrD,IACE,GAAAO,IAAoD,IAA3BV,EAAOiB,gBAClC,OAAKX,GAOL,OAAAJ,EAAA,MAAAM,OAAA,EAAAA,EAAQU,QAARhB,EAAAiB,KAAAX,EACE,6DAEKY,EAAkB,IACpBX,EAEHQ,gBAAiBjB,EAAOiB,gBACpBjB,EAAOiB,gBACP,uBACJI,MAAO,CACLC,SAAS,EACThB,YACAE,SACAe,OAAQlB,EACHmB,GACCnB,EAAsB,CACpBoB,KAAMD,EAAME,WACZC,cAAeA,IAAMH,EAAMG,cAAcH,UAE7C,OAzBN,OAAAvB,EAAA,MAAAO,OAAA,EAAAA,EAAQoB,QAAR3B,EAAAkB,KAAAX,EACE,qIAEKqB,EAAqBpB,UA0BzBqB,GAECC,QAAAH,MACN,+CACAE,EACA,8CAEJ,CACA,OAAOD,EAAqBpB,EAAO,EAmBrC,SAASL,IACH,IAEK,MAAsC,qBAA1BO,IAAIqB,iBAAsB,CACvC,MAER,CACI,IAEK,MAAkC,SAAlCnB,QAAQF,IAAIqB,iBAAsB,CACnC,MAER,CACO,OAAA,CACT,CAGA,SAASzB,IACH,IAEF,mBAAmBI,IAAIsB,iBAAA,CACjB,MAER,CACI,IAEF,OAAOpB,QAAQF,IAAIsB,iBAAA,CACb,MAER,CACF"}