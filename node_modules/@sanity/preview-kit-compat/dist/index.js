import{useState as n,useEffect as e,useMemo as t,useSyncExternalStore as o,useCallback as i}from"react";let r;const s=new Uint8Array(16);function c(){if(!r&&(r="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!r))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return r(s)}const a=[];for(let n=0;n<256;++n)a.push((n+256).toString(16).slice(1));var d={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function u(n,e,t){if(d.randomUUID&&!e&&!n)return d.randomUUID();const o=(n=n||{}).random||(n.rng||c)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,e){t=t||0;for(let n=0;n<16;++n)e[t+n]=o[n];return e}return function(n,e=0){return a[n[e+0]]+a[n[e+1]]+a[n[e+2]]+a[n[e+3]]+"-"+a[n[e+4]]+a[n[e+5]]+"-"+a[n[e+6]]+a[n[e+7]]+"-"+a[n[e+8]]+a[n[e+9]]+"-"+a[n[e+10]]+a[n[e+11]]+a[n[e+12]]+a[n[e+13]]+a[n[e+14]]+a[n[e+15]]}(o)}const f=["channel/disconnect","channel/response","channel/heartbeat"],p=["handshake/syn","handshake/syn-ack","handshake/ack"],l=n=>f.some((e=>e===n)),h=n=>p.some((e=>e===n));function m(n){const e=window.self!==window.top,t={buffer:[],id:null,origin:null,status:"connecting"};function o(e,o){if(h(e)||l(e)||"connecting"!==t.status&&"reconnecting"!==t.status){if(t.id&&t.origin){const i={connectionId:t.id,data:o,domain:"sanity/channels",from:n.id,id:u(),to:n.connectTo,type:e};try{parent.postMessage(i,{targetOrigin:t.origin})}catch(e){throw new Error(`Failed to postMessage '${i.id}' on '${n.id}'`)}}}else t.buffer.push({type:e,data:o})}function i(e){if(function(e){const{data:t}=e;return"sanity/channels"===t.domain&&t.to===n.id&&t.from===n.connectTo&&"channel/response"!==t.type}(e)){const{data:i}=e;if(h(i.type)&&i.data){if("handshake/syn"===i.type)return t.origin=e.origin,t.id=i.data.id,r("connecting"),void o("handshake/syn-ack",{id:t.id});if("handshake/ack"===i.type&&i.data.id===t.id)return void r("connected")}else if(i.connectionId===t.id&&e.origin===t.origin){if("channel/disconnect"===i.type)return void r("disconnected");{const e=[i.type,i.data];n.onEvent?.(...e),o("channel/response",{responseTo:i.id})}return}}}function r(e){t.status=e,n?.onStatusUpdate?.(e),"connected"===e&&function(){const n=[...t.buffer];t.buffer.splice(0,t.buffer.length),n.forEach((({type:n,data:e})=>{o(n,e)}))}()}return window.addEventListener("message",i,!1),r("connecting"),{destroy:function(){["disconnected"].includes(t.status)||r("disconnected"),window.removeEventListener("message",i,!1)},inFrame:e,send:function(n,e){o(n,e)}}}function y(t,o,i){const[r,s]=n(),[c,a]=n(!1);e((()=>{if(window.self===window.top)return;const n=m({id:"preview-kit",connectTo:"presentation",onStatusUpdate(n){"connected"===n?a(!0):"disconnected"===n&&a(!1)}}),e=setTimeout((()=>s(n)),0);return()=>{clearTimeout(e),n.destroy(),s(void 0)}}),[i,o]);const d=JSON.stringify(Array.from(t.keys()));e((()=>{"[]"!==d&&r&&c&&r.send("preview-kit/documents",{projectId:o,dataset:i,perspective:"previewDrafts",documents:Array.from(t.values())})}),[d,r,c,i,t,o])}function v(n){const e=t((()=>JSON.stringify(n||{})),[n]);return t((()=>JSON.parse(e)),[e])}function g(t){const{refreshInterval:r}=t,s=function(){const[t,i]=n(!1);e((()=>{i(navigator.onLine);const n=()=>i(!0),e=()=>i(!1);return window.addEventListener("online",n),window.addEventListener("offline",e),()=>{window.removeEventListener("online",n),window.removeEventListener("offline",e)}}),[]);const r=o(w,(()=>document.visibilityState),(()=>"hidden"));return!t||"hidden"===r}(),[c,a]=n("hit"),d=i((()=>(a("inflight"),()=>a("hit"))),[]);return e((()=>{if(!r||"hit"!==c)return;const n=setTimeout((()=>a("stale")),r);return()=>clearTimeout(n)}),[r,c]),e((()=>{if("hit"!==c)return;const n=()=>a("stale");return window.addEventListener("focus",n),()=>window.removeEventListener("focus",n)}),[r,c]),e((()=>{s&&"hit"===c&&a("stale"),s||"stale"!==c||a("refresh")}),[s,c]),[c,d]}function w(n){return document.addEventListener("visibilitychange",n),()=>document.removeEventListener("visibilitychange",n)}export{y as useDocumentsInUse,v as useQueryParams,g as useRevalidate};//# sourceMappingURL=index.js.map
